!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("RetroTetris",[],e):"object"==typeof exports?exports.RetroTetris=e():t.RetroTetris=e()}(self,(()=>(()=>{"use strict";var t={d:(e,i)=>{for(var o in i)t.o(i,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:i[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>p});var i=function(){function t(t){this.game=t,this.boardWidth=300,this.boardHeight=500,this.horizontalBlockCount=15,this.verticalBlockCount=25,this.blockWidth=this.boardWidth/this.horizontalBlockCount,this.blockHeight=this.boardHeight/this.verticalBlockCount,this.blocks=[];for(var e=0;e<this.horizontalBlockCount;e++){this.blocks[e]=[];for(var i=0;i<this.verticalBlockCount;i++)this.blocks[e][i]=null}}return t.prototype.draw=function(t){for(var e=0;e<this.horizontalBlockCount;e++)for(var i=this.blocks[e],o=0;o<this.verticalBlockCount;o++)null!=i[o]&&i[o].draw(t)},t.prototype.getPosition=function(t,e){return[t*this.blockWidth,(this.verticalBlockCount-(e+1))*this.blockHeight]},t.prototype.add=function(t){for(var e=0;e<t.blocks.length;e++){var i=t.blocks[e];this.blocks[i.x][i.y]=i}},t.prototype.clear=function(){for(var t=0;t<this.horizontalBlockCount;t++)for(var e=0;e<this.verticalBlockCount;e++)this.blocks[t][e]=null},t}();const o=i;var r=function(){function t(t,e,i,o){this.game=t,this.x=e,this.y=i,this.style=o,this.lineThickness=3}return t.prototype.update=function(){},t.prototype.draw=function(t){var e=this.game.board.getPosition(this.x,this.y),i=e[0],o=e[1];switch(this.style){case 0:t.fillStyle="#8b936f",t.fillRect(i,o,this.game.board.blockWidth,this.game.board.blockHeight);break;case 1:t.fillStyle="#6d735c",t.fillRect(i,o,this.game.board.blockWidth,this.game.board.blockHeight);break;case 2:t.fillStyle="#bccc8c",t.fillRect(i,o,this.game.board.blockWidth,this.game.board.blockHeight);break;case 3:t.fillStyle="#7c7c5c",t.fillRect(i,o,this.game.board.blockWidth,this.game.board.blockHeight)}t.lineWidth=this.lineThickness,t.strokeStyle="#474a40",t.strokeRect(i+this.lineThickness/2,o+this.lineThickness/2,this.game.board.blockWidth-this.lineThickness,this.game.board.blockHeight-this.lineThickness)},t}();const n=r;var s=function(){function t(t,e,i,o){this.game=t,this.x=e,this.y=i,this.matrix=o,this.orientation=Math.floor(3*Math.random());var r=this.matrix[this.orientation];this.blocks=[],this.style=Math.floor(4*Math.random());for(var s=0,a=0;a<r.length;a+=2){var h=this.blocks[s++]=new n(t,e+r[a],i+r[a+1],this.style);this.game.board.blocks[h.x][h.y]=h}}return t.prototype.canDrop=function(t,e,i){for(var o=this.matrix[i],r=0;r<o.length;r+=2){var n=t+o[r],s=e+o[r+1];if(s<0)return!1;if(n<0||n>=this.game.board.horizontalBlockCount)return!1;var a=this.game.board.blocks[n][s];if(null!=a){for(var h=!1,l=0;l<this.blocks.length;l++)if(a==this.blocks[l]){h=!0;break}if(!h)return!1}}return!0},t.prototype.rotateRight=function(){var t=(this.orientation+1)%4;this.canDrop(this.x,this.y,t)&&(this.orientation=t,console.log(this.orientation))},t.prototype.moveDown=function(){for(var t=0;t<this.blocks.length;t++){var e=this.blocks[t];this.game.board.blocks[e.x][e.y]=null}this.y--;var i=this.matrix[this.orientation],o=0;for(t=0;t<i.length;t+=2)e=this.blocks[o++]=new n(this.game,this.x+i[t],this.y+i[t+1],this.style),this.game.board.blocks[e.x][e.y]=e},t.prototype.moveLeft=function(){this.canDrop(this.x-1,this.y,this.orientation)&&this.x--},t.prototype.moveRight=function(){this.canDrop(this.x+1,this.y,this.orientation)&&this.x++},t.Create=function(e){return new t(e,Math.max(Math.floor(Math.random()*e.board.horizontalBlockCount-3),2),e.board.verticalBlockCount-2,h.getTetrominoeMatrix())},t}();const a=s;var h=function(){function t(){}return t.getTetrominoeMatrix=function(){switch(Math.round(4*Math.random())){case 0:return t.straightTetrominoe;case 1:return t.tTetrominoe;case 2:return t.lTetrominoe;case 3:return t.skewTetrominoe;case 4:return t.squareTetrominoe}},t.straightTetrominoe=[[0,-1,0,0,0,1,0,2],[-1,0,0,0,1,0,2,0],[0,-1,0,0,0,1,0,2],[-1,0,0,0,1,0,2,0]],t.tTetrominoe=[[-1,0,0,0,1,0,0,-1],[0,1,0,0,0,-1,-1,0],[-1,0,0,0,1,0,0,1],[0,1,0,0,0,-1,1,0]],t.lTetrominoe=[[0,-1,0,0,0,1,1,1],[-1,0,0,0,1,0,1,-1],[0,1,0,0,0,-1,-1,-1],[-1,0,0,0,1,0,-1,1]],t.skewTetrominoe=[[0,1,0,0,1,0,1,-1],[1,0,0,0,0,-1,-1,-1],[0,-1,0,0,-1,0,-1,1],[-1,0,0,0,0,1,1,1]],t.squareTetrominoe=[[0,0,0,1,1,0,1,1],[0,0,0,1,1,0,1,1],[0,0,0,1,1,0,1,1],[0,0,0,1,1,0,1,1]],t}();const l=function(){function t(){this.board=new o(this),this.fallingTetrominoe=a.Create(this),this.board.add(this.fallingTetrominoe),this.score=0,this.running=!0}return t.prototype.update=function(){if(this.running){this.fallingTetrominoe.canDrop(this.fallingTetrominoe.x,this.fallingTetrominoe.y-1,this.fallingTetrominoe.orientation)?this.fallingTetrominoe.moveDown():(this.fallingTetrominoe=a.Create(this),this.board.add(this.fallingTetrominoe),this.running=this.fallingTetrominoe.canDrop(this.fallingTetrominoe.x,this.fallingTetrominoe.y-1,this.fallingTetrominoe.orientation));for(var t=0;t<this.board.verticalBlockCount;t++){for(var e=!0,i=0;i<this.board.horizontalBlockCount;i++)if(null==this.board.blocks[i][t]){e=!1;break}if(e){for(this.score++,i=0;i<this.board.horizontalBlockCount;i++)this.board.blocks[i][t]=null;for(var o=t+1;o<this.board.verticalBlockCount;o++)for(i=0;i<this.board.horizontalBlockCount;i++){var r=this.board.blocks[i][o];null!=r&&(r.y--,this.board.blocks[i][o]=null,this.board.blocks[i][r.y]=r)}}}}},t.prototype.draw=function(t){t.strokeStyle="gray";var e=this.board.getPosition(0,-2),i=e[0],o=e[1],r=this.board.getPosition(this.board.horizontalBlockCount,this.board.verticalBlockCount),n=r[0],s=r[1];t.strokeRect(i,s,n,o),this.board.draw(t)},t.prototype.restart=function(){this.board.clear(),this.fallingTetrominoe=a.Create(this),this.board.add(this.fallingTetrominoe),this.score=0,this.running=!0},t}();const c=function(){function t(t){this.tetris=t,this.scores=[],this.textHeight=30}return t.prototype.draw=function(t){t.font="25px pixel",t.fillStyle="black",t.textBaseline="top";var e=t.measureText("00000").width;this.drawCenteredText(t,"Highscores",this.textHeight),this.drawCenteredText(t,"Click to play again",this.tetris.canvas.height-2*this.textHeight),t.font="20px pixel",e=t.measureText("00000").width,t.fillText("rank",this.tetris.canvas.width/2-2*e,2*this.textHeight),t.fillText("name",(this.tetris.canvas.width-e)/2,2*this.textHeight),t.fillText("score",this.tetris.canvas.width/2+e,2*this.textHeight);for(var i=0;i<this.scores.length;i++){var o=this.scores[i],r=String(o.rank).padStart(4,"0").toString(),n=String(o.name).padEnd(5," ").toString(),s=String(o.score).padStart(4,"0").toString(),a=(i+3)*this.textHeight;t.fillText(r,this.tetris.canvas.width/2-2*e,a),t.fillText(n,(this.tetris.canvas.width-e)/2,a),t.fillText(s,this.tetris.canvas.width/2+e,a)}},t.prototype.drawCenteredText=function(t,e,i){t.fillText(e,(this.tetris.canvas.width-t.measureText(e).width)/2,i)},t.prototype.handleClick=function(t,e){this.tetris.sidebar.showHighscores=!1,this.tetris.game.restart()},t.prototype.submit=function(t,e){return i=this,o=void 0,n=function(){var i,o,r;return function(t,e){var i,o,r,n,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(a){return function(h){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;n&&(n=0,a[0]&&(s=0)),s;)try{if(i=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],o=0}finally{i=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,h])}}}(this,(function(n){switch(n.label){case 0:this.scores=[],n.label=1;case 1:return n.trys.push([1,4,,5]),console.log("submitting score"),[4,fetch("".concat(this.tetris.apiUrl,"/api/tetris/highscores"),{method:"POST",body:JSON.stringify({name:e,score:t}),headers:{"Content-Type":"application/json",Accept:"application/json",sessionid:"07daa504-864b-4055-a115-113a9d8d31d6",userid:"07daa504-864b-4055-a115-113a9d8d31d6"}})];case 2:if(!(i=n.sent()).ok)throw new Error("Error! status: ".concat(i.status));return[4,i.json()];case 3:return o=n.sent(),this.scores=o.scores,console.log("result is: ",JSON.stringify(o,null,4)),[2,o];case 4:return r=n.sent(),console.log("unexpected error: ",r),[2,null];case 5:return[2]}}))},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{h(n.next(t))}catch(t){e(t)}}function a(t){try{h(n.throw(t))}catch(t){e(t)}}function h(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(s,a)}h((n=n.apply(i,o||[])).next())}));var i,o,r,n},t}();var u;!function(t){t[t.Up=0]="Up",t[t.Down=1]="Down",t[t.Left=2]="Left",t[t.Right=3]="Right"}(u||(u={}));const d=function(){function t(t){var e=this;this.tetris=t,this.textInput="",this.tetris.canvas.addEventListener("click",(function(t){if(!e.tetris.game.running){var i=e.tetris.canvas.getBoundingClientRect(),o=t.clientX-i.left,r=t.clientY-i.top;e.tetris.sidebar.showHighscores?e.tetris.highscores.handleClick(o,r):e.tetris.sidebar.handleClick(o,r)}})),window.addEventListener("keydown",(function(t){"Backspace"!==t.key&&"Delete"!==t.key||e.textInput.length>0&&(e.textInput=e.textInput.slice(0,-1));var i=t.key.toLowerCase();if(1===i.length){if(e.textInput.length>=5)return;e.textInput+=i}e.tetris.game.running&&("ArrowUp"===t.key?(e.tetris.game.fallingTetrominoe.rotateRight(),t.preventDefault()):"ArrowDown"===t.key?(e.tetris.game.fallingTetrominoe.canDrop(e.tetris.game.fallingTetrominoe.x,e.tetris.game.fallingTetrominoe.y-1,e.tetris.game.fallingTetrominoe.orientation)&&(e.tetris.game.fallingTetrominoe.moveDown(),e.tetris.draw()),t.preventDefault()):"ArrowLeft"===t.key?(e.tetris.game.fallingTetrominoe.moveLeft(),t.preventDefault()):"ArrowRight"===t.key&&(e.tetris.game.fallingTetrominoe.moveRight(),t.preventDefault()))}))}return t.prototype.clearText=function(){this.textInput=""},t.prototype.getText=function(){return this.textInput},t.prototype.canSubmit=function(){return this.textInput.length>=3},t}();var f=function(){function t(t,e,i){this.textHeight=35,this.game=t,this.retrotetris=e,this.inputHandler=i,this.showHighscores=!1}return t.prototype.draw=function(t){t.font="28px pixel",t.fillStyle="black",t.textBaseline="top";var e=this.game.board.boardWidth+(this.retrotetris.canvas.width-this.game.board.boardWidth)/2;if(this.drawCenteredText(t,"Score",e,this.textHeight),this.drawCenteredText(t,String(this.game.score).padStart(4,"0").toString(),e,2*this.textHeight),!this.game.running){if(null!=this.retrotetris.apiUrl){this.drawCenteredText(t,"Game Over",e,3*this.textHeight),this.drawCenteredText(t,"Name:",e,5*this.textHeight);var i=String(this.inputHandler.getText()).padStart(5,"_").toString();this.drawCenteredText(t,i,e,6*this.textHeight),this.inputHandler.canSubmit()&&this.drawCenteredText(t,"Submit",e,8*this.textHeight)}this.drawCenteredText(t,"Play Again",e,this.retrotetris.canvas.height-this.textHeight)}},t.prototype.drawCenteredText=function(t,e,i,o){t.fillText(e,i-t.measureText(e).width/2,o)},t.prototype.handleClick=function(t,e){var i=this,o=this.retrotetris.canvas.height-this.textHeight,r=8*this.textHeight;e-o>=0&&e-o<=this.textHeight?(this.showHighscores=!1,this.game.restart()):e-r>=0&&e-r<=this.textHeight&&this.inputHandler.canSubmit()&&this.retrotetris.highscores.submit(this.game.score,this.inputHandler.getText()).then((function(t){i.showHighscores=!0}))},t}();const g=f,p=function(){function t(t){if(this.apiUrl=t,this.canvas=document.getElementById("tetris-canvas"),null==this.canvas)throw new Error("Could not find canvas.");this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.canvas.width=500,this.canvas.height=500,this.game=new l,this.inputHandler=new d(this),this.sidebar=new g(this.game,this,this.inputHandler),this.lastTimeStamp=0,this.highscores=new c(this)}return t.prototype.Start=function(){this.animate(0)},t.prototype.animate=function(t){var e=this;t-this.lastTimeStamp>=200&&(this.lastTimeStamp=t,this.game.update()),this.draw(),requestAnimationFrame((function(t){return e.animate(t)}))},t.prototype.draw=function(){this.ctx.fillStyle="#94d300",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.sidebar.showHighscores?this.highscores.draw(this.ctx):(this.game.draw(this.ctx),this.sidebar.draw(this.ctx))},t}();return e.default})()));